#### 缓存的分类

---

根据是否需要向服务器发起http请求，将缓存分为两个部分：

1. 强制缓存
2. 协商缓存

---

##### 强（制）缓存

不会向服务器发起请求，直接从缓存中读取资源，在chrome控制台 Network 选项中可以看到该请求返回200的状态码，并且 size 显示的是 `from memory cache`或者`from disk cache`。强缓存可以通过设置HTTP Header实现：`Expires`和`Cache-Control`

+ `Expires`：缓存的过期时间，用来指定资源到期时间，是服务器的具体时间点。受限于本地时间和服务器时间，如果修改了本地时间，会造成缓存失败；服务器时间和本地时间存在差异也会造成缓存的差异，是HTTP1.0的产物
+ `Cache-Control`：用时间戳来表示过期时间，可以在请求头或者响应头中设置，并且可以组合使用多种指令（public、private、no-cache、no-store、max-age）
+ Cache-Control和Expires同时存在的话，Cache-Control的优先级高于Expires，Expires的存在其实只是一种兼容性写法。

---

##### 协商缓存

问一下服务器是否可用，强缓存失效后，浏览器携带缓存标识即上一个你给我的时间，向服务器发起请求，由服务器根据缓存标识决定是否使用缓存的过程。主要有两种情况：

+ 协商缓存成功，返回304和Modified
+ 协商缓存失效，返回200和请求结果

协商缓存通过设置两种HTTP Header实现：Last-Modified和ETag

+ <font color=orange>`Last-Modified和if-Modified-Since`：浏览器第一次访问资源，服务器返回资源的同时，在 response header中添加` Last-Modifield`的header，指的是这个资源在服务器上的最后修改时间，浏览器接收后缓存文件和header。下次请求这个资源时，浏览器检测到有Last-Modified这个header，于是会添加 `if-Modified-Since`这个header，指的就是`Last-Modified`中的值，服务器再次接收到这个资源请求，会根据`If-Modified-Since`中的值与服务器中的这个资源最后修改时间对比，如果没有变化返回304和响应体，直接从缓存中读取，如果If-Modified-Since小于服务器这个资源的最后修改时间，说明文件有更新，于是返回新的资源文件和200.</font>
+ <font color=green>ETag和If-None-Match：根据修改时间来决定是否缓存有一些弊端，比如本地打开了缓存文件，会导致Last-Modified被修改，服务器端不能命中缓存导致发送相同请求。ETag是服务器端响应请求时，返回当前资源文件的一个唯一标识，只要资源有变化，ETag就会重新生成。浏览器在下一次加载资源向服务器发送请求时，会将上一次返回的ETag值放到 If-None-Match中，服务器拿着这个值和自己服务器上的ETag对比是否一致，如果一致，返回304和空响应体，如果不一致，返回200和新的请求资源</font>
+ 两者对比：在精确度上ETag优于Last-Modifield，在性能上Last-Modifield优于ETag，在优先级上，ETag优于Last-Modifield

---

##### 缓存位置

我们打开F12，size那边会出现两种

1. `memory cache`：内存中，当我们直接刷新页面可以看到一些js资源的size选项显示 `from memory cache`
2. `disk cache`：磁盘中，一些不常常访问的资源，或者下次不用下载的资源，如css等
3. 资源本身大小，比如 13.6k

---

##### 三级缓存的原理

1. 先查找内存，如果内存中存在，从内存中加载
2. 如果内存中没有找到，选择硬盘获取；如果硬盘中有，从硬盘中加载
3. 如果硬盘中未查找到，那就进行网络请求
4. 请求到的资源缓存到浏览器内存或硬盘

---

##### HTTP状态码以及区别

1. 200 from memory cache：不访问服务器，一般已经加载过该资源且缓存在了内存中，直接从内存中读取。浏览器关闭后，数据将不会存在，资源被释放掉了，再次打开相同的页面时，不会出现 memory cache

   

2. 200 from disk cache：不访问服务器，已经在之前的某个时间段加载过该资源，直接从硬盘中读取缓存。关闭浏览器之后数据依然存在，不会随着该页面的关闭而释放掉，下次打开仍然会是 from disk cache

   

3. 200 大小，如 3.4k：访问服务器，size显示为实际资源的大小

   

4. 304 Not Modified：访问服务器，发现数据没有更新，服务器返回此状态码使用本地资源，然后从缓存中读取数据。这种在请求头中有两个请求参数：`If-Modified-Since`和`If-None-Match`

---

#### 总结

1. 当我们通过浏览器访问资源时，会命中缓存的规则。缓存分为两种：强制缓存 和 协商缓存。
2. 浏览器会有一个策略，去决定命中强缓存还是协商缓存。它会先从内存中查找，找到则返回资源，找不到的话继续去硬盘中查找，找到则返回资源，找不到再去请求网络。请求网络的时候，会带着一些标识，比如最近一次修改的时间，ETag等等去服务端匹配，如果这个时间早于服务端的最新更新时间或者ETag匹配不上，服务端就会把最新的资源返回回来并且更新修改时间和ETag