\28. 跨域

定义：由于浏览器的同源策略，我们不能通过ajax去请求不同源中的文档，并且不同域中的框架之间是不能进行js的交互操作的，凡是域名、协议、端口，有一个不同，即为跨域

说明：如果是协议和端口造成的跨域，前端是无能为力的

解决：

1. 通过document.domain跨域

-  有一个页面www.damonare.cn/a.html，这个页面有个iframe，它的src是damonare.cn/b.html，这两个页面是不同域的，我们不能通过js获取iframe里面的东西。
- 此方法适用于子域名不同的，即需要通信的两个页面属于同一个根域名下：eg1.aaa.cc 与 eg2.aaa.cc。
- 使用方法：分别在A B两个页面设置document.domain为公共的根域名即可

```html
<iframe id="iframe" 
        src="http://damonare.cn/b.html" 
        onload="test()">
</iframe>
<script>
   document.domain='damonare.cn';// 设置成主域
   function test(){
       alert(document.getElementId('iframe').contentWindow)
   }
</script>

<script>
   document.domain='damonare.cn'; // 设置成主域
</script>
```



1. postMessage

- postMessage是HTML5新增的特性，本身就用于安全跨域通信。所以，只要你的浏览器环境支持H5，那么就可以考虑这个方法。包括接收信息的Message时间和发送信息的postMessage方法
- 发送信息的postMessage方法是向外界窗口发送信息

`otherWindow.postMessage(message,targetOrigin);`

- 接收信息的message事件

`window.addEventListenet('message',onmessage,false);`

```html
// a.html   www.nealyang.cn/a.html
<iframe id="iframe" 
        src="http://www.neal.cn/b.html" 
        style="display:none"></iframe>
iframe.contentWindow.postMessage(data,"http://www.neal.cn");     

// b.html www.neal.cn/b.html
window.addEventListener('message',function(e){
    console.log(e.data);
   window.parent.postMessage(data,"http://www.nealyang.cn"); 
   // 数据处理后发回去
})   
```



1. jsonp，通过动态创建script标签的方式，来实现跨域，不过只能实现get请求

```javascript
let st = document.createElement('script');
st.src="http://www.nealyang.cn/login?username=Nealyang&callback=callback";

document.body.appendChild(st);

function callback(res){
    console.log(res);
}
```



1. 跨域资源共享CORS

- 它允许浏览器向跨源服务器，发出XMLHttpRequest请求，从而克服了AJAX只能同源使用的限制
- CORS需要浏览器和服务器同时支持
- 整个CORS通信过程，都是浏览器自动完成，不需要用户参与。对于开发者来说，CORS通信与同源的AJAX通信没有差别，代码完全一样。浏览器一旦发现AJAX请求跨源，就会自动添加一些附加的头信息，有时还会多出一次附加的请求，但是用户不会有感觉。因此，CORS通信的关键是服务器，只要服务器实现了CORS接口，就可以实现跨源通信
- 两种请求：简单请求和非简单请求
- 简单请求：请求方式为HEAD，POST或者GET
- 对于简单请求，浏览器直接发出CORS请求，具体来说，就是在头信息中，增加一个Origin字段。下面是一个例子，浏览器发现这次跨源AJAX请求是简单请求，就自动在头信息中，添加一个Origin字段

```
GET /cors HTTP/1.1 
Origin: http://api.bob.com 
Host: api.alice.com 
Accept-Language: en-US 
Connection: keep-alive User-Agent: Mozilla/5.0
```



Origin字段用来说明，本次请求来源于哪个源，服务器根据这个值，决定是否同意这次请求

如果Origin指定的源，不在许可范围内，服务器会返回一个正常的HTTP响应，浏览器发现，这个回应的头信息没有包含Access-Control-Allow-Origin字段，就发现出错了，从而抛出跨域错误

如果Origin指定的域，在许可范围内，服务器返回的响应，会多出几个信息字段

```
Access-Control-Allow-Origin: http://api.bob.com 
Access-Control-Allow-Credentials: true 
Access-Control-Expose-Headers:FooBar Content-Type:text/html; charset=utf-8
```



上面的信息中，有三个与CORS请求相关的字段，都是以Access-Control开头

非简单请求，在发送正式AJAX请求之前，浏览器会发送一次预检请求，要求服务器确认可以这样请求